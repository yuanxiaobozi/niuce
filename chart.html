<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>因子风险收益图 - 牛策网</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        .header {
            background: #fff;
            border-bottom: 1px solid #e8e8e8;
            padding: 16px 0;
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: 600;
            color: #1890ff;
            text-decoration: none;
        }
        .logo span {
            color: #666;
            font-size: 14px;
            margin-left: 12px;
            font-weight: normal;
        }
        .nav {
            display: flex;
            gap: 20px;
        }
        .nav a {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .nav a:hover {
            color: #1890ff;
            background: #f0f0f0;
        }
        .nav a.active {
            color: #1890ff;
            background: #e6f7ff;
        }
        .update-time {
            color: #999;
            font-size: 13px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-row {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .stat-card {
            background: #fff;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            padding: 16px 20px;
            flex: 1;
            min-width: 150px;
        }
        .stat-card .label {
            font-size: 13px;
            color: #666;
            margin-bottom: 4px;
        }
        .stat-card .value {
            font-size: 20px;
            font-weight: 600;
            color: #1890ff;
        }
        .stat-card .value.up {
            color: #f5222d;
        }
        .stat-card .value.down {
            color: #52c41a;
        }
        .chart-container {
            background: #fff;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            padding: 24px;
            margin-bottom: 24px;
        }
        .chart-title {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f5222d;
        }
        .footer {
            text-align: center;
            padding: 24px 0;
            color: #999;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <a href="index.html" class="logo">
                牛策网
                <span>A股因子库</span>
            </a>
            <div class="nav">
                <a href="index.html">因子列表</a>
                <a href="chart.html" class="active">风险收益图</a>
            </div>
            <div class="update-time" id="update-time">数据加载中...</div>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-row">
            <div class="stat-card">
                <div class="label">策略总数</div>
                <div class="value" id="total-count">-</div>
            </div>
            <div class="stat-card">
                <div class="label">平均年化收益</div>
                <div class="value up" id="avg-annual">-</div>
            </div>
            <div class="stat-card">
                <div class="label">平均最大回撤</div>
                <div class="value down" id="avg-dd">-</div>
            </div>
            <div class="stat-card">
                <div class="label">平均夏普比率</div>
                <div class="value" id="avg-sharpe">-</div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">年化收益 vs 最大回撤</div>
            <div class="chart-wrapper">
                <canvas id="ddChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">年化收益 vs 夏普比率</div>
            <div class="chart-wrapper">
                <canvas id="sharpeChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">年化收益 vs 波动率</div>
            <div class="chart-wrapper">
                <canvas id="volChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">年化收益分布</div>
            <div class="chart-wrapper">
                <canvas id="histChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">TOP10 年化收益因子</div>
            <div class="chart-wrapper">
                <canvas id="top10Chart"></canvas>
            </div>
        </div>
        
        <div class="footer">
            数据来源：<a href="https://guorn.com/user/strategy?uid=13496" target="_blank">果仁网</a>
        </div>
    </div>

    <script>
        const DATA_URL = 'https://gupiao-1254084492.cos.ap-guangzhou.myqcloud.com/strategies_data.json';
        let charts = {};
        
        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toFixed(2) + '%';
        }
        
        function formatNumber(value, decimals) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toFixed(decimals);
        }
        
        function calculateStats(data) {
            const total = data.length;
            const avgAnnual = data.reduce((sum, s) => sum + (s.annual_return || 0), 0) / total;
            const avgDd = data.reduce((sum, s) => sum + (s.max_dd || 0), 0) / total;
            const avgSharpe = data.reduce((sum, s) => sum + (s.sharpe_ratio || 0), 0) / total;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('avg-annual').textContent = formatPercent(avgAnnual);
            document.getElementById('avg-dd').textContent = formatPercent(avgDd);
            document.getElementById('avg-sharpe').textContent = formatNumber(avgSharpe, 2);
        }
        
        function renderCharts(data) {
            Object.values(charts).forEach(c => c && c.destroy());
            
            const scatterData = {
                dd: data.map(s => ({
                    x: s.max_dd || 0,
                    y: s.annual_return || 0,
                    sharpe: s.sharpe_ratio || 0,
                    name: s.name
                })),
                sharpe: data.map(s => ({
                    x: s.sharpe_ratio || 0,
                    y: s.annual_return || 0,
                    maxDd: s.max_dd || 0,
                    name: s.name
                })),
                vol: data.map(s => ({
                    x: s.volatility || 0,
                    y: s.annual_return || 0,
                    sharpe: s.sharpe_ratio || 0,
                    name: s.name
                }))
            };
            
            const scatterOptions = (xTitle, xCallback) => ({
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const p = ctx.raw;
                                return [
                                    p.name,
                                    '年化收益: ' + p.y.toFixed(2) + '%',
                                    xTitle + ': ' + (xCallback ? xCallback(p.x) : p.x.toFixed(2))
                                ];
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: { display: true, text: xTitle, font: { size: 12 } },
                        ticks: { callback: v => xCallback ? xCallback(v) : v }
                    },
                    y: {
                        title: { display: true, text: '年化收益 (%)', font: { size: 12 } },
                        ticks: { callback: v => v + '%' }
                    }
                }
            });
            
            charts.dd = new Chart(document.getElementById('ddChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: scatterData.dd,
                        backgroundColor: 'rgba(24, 144, 255, 0.6)',
                        borderColor: '#1890ff',
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: scatterOptions('最大回撤', v => v.toFixed(1) + '%')
            });
            
            charts.sharpe = new Chart(document.getElementById('sharpeChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: scatterData.sharpe,
                        backgroundColor: 'rgba(82, 196, 26, 0.6)',
                        borderColor: '#52c41a',
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: scatterOptions('夏普比率', v => v.toFixed(2))
            });
            
            charts.vol = new Chart(document.getElementById('volChart'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        data: scatterData.vol,
                        backgroundColor: 'rgba(250, 173, 20, 0.6)',
                        borderColor: '#faad14',
                        borderWidth: 1,
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: scatterOptions('波动率', v => v.toFixed(1) + '%')
            });
            
            const annualReturns = data.map(s => s.annual_return || 0).sort((a, b) => a - b);
            const minVal = Math.floor(annualReturns[0] / 5) * 5;
            const maxVal = Math.ceil(annualReturns[annualReturns.length - 1] / 5) * 5;
            const binSize = 5;
            const bins = [];
            const labels = [];
            
            for (let i = minVal; i < maxVal; i += binSize) {
                labels.push(i + '~' + (i + binSize) + '%');
                bins.push(data.filter(s => {
                    const v = s.annual_return || 0;
                    return v >= i && v < i + binSize;
                }).length);
            }
            
            charts.hist = new Chart(document.getElementById('histChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '因子数量',
                        data: bins,
                        backgroundColor: 'rgba(24, 144, 255, 0.6)',
                        borderColor: '#1890ff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: '年化收益区间', font: { size: 12 } },
                            ticks: { maxRotation: 45, minRotation: 0, font: { size: 11 } }
                        },
                        y: {
                            title: { display: true, text: '因子数量', font: { size: 12 } },
                            ticks: { stepSize: 1 }
                        }
                    }
                }
            });
            
            const top10 = [...data].sort((a, b) => (b.annual_return || 0) - (a.annual_return || 0)).slice(0, 10);
            
            charts.top10 = new Chart(document.getElementById('top10Chart'), {
                type: 'bar',
                data: {
                    labels: top10.map(s => s.name.length > 10 ? s.name.slice(0, 10) + '...' : s.name),
                    datasets: [{
                        label: '年化收益',
                        data: top10.map(s => s.annual_return || 0),
                        backgroundColor: top10.map((_, i) => {
                            const colors = ['#f5222d', '#fa541c', '#fa8c16', '#faad14', '#fadb14',
                                           '#a0d911', '#52c41a', '#13c2c2', '#1890ff', '#2f54eb'];
                            return colors[i];
                        }),
                        borderWidth: 0
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: ctx => '年化收益: ' + ctx.raw.toFixed(2) + '%',
                                afterLabel: ctx => {
                                    const s = top10[ctx.dataIndex];
                                    return ['夏普: ' + (s.sharpe_ratio || 0).toFixed(2), '回撤: ' + (s.max_dd || 0).toFixed(2) + '%'];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: '年化收益 (%)', font: { size: 12 } },
                            ticks: { callback: v => v + '%' }
                        },
                        y: {
                            ticks: { font: { size: 12 } }
                        }
                    }
                }
            });
        }
        
        async function loadData() {
            try {
                const response = await fetch(DATA_URL + '?t=' + Date.now());
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                const strategies = data.strategies || data;
                
                if (data.fetch_time) {
                    document.getElementById('update-time').textContent = '最后更新: ' + data.fetch_time;
                }
                
                calculateStats(strategies);
                renderCharts(strategies);
                
            } catch (error) {
                console.error('加载失败:', error);
                document.querySelector('.container').innerHTML = 
                    '<div class="error">数据加载失败: ' + error.message + '</div>';
            }
        }
        
        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device, initial-scale=1.0">
    <title>牛策网 - A股因子库</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
        }
        .header {
            background: #fff;
            border-bottom: 1px solid #e8e8e8;
            padding: 16px 0;
        }
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 24px;
            font-weight: 600;
            color: #1890ff;
        }
        .logo span {
            color: #666;
            font-size: 14px;
            margin-left: 12px;
            font-weight: normal;
        }
        .nav {
            display: flex;
            gap: 20px;
        }
        .nav a {
            color: #666;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .nav a:hover {
            color: #1890ff;
            background: #f0f0f0;
        }
        .nav a.active {
            color: #1890ff;
            background: #e6f7ff;
        }
        .update-time {
            color: #999;
            font-size: 13px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .stats-bar {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
            background: #fff;
            padding: 16px 20px;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 600;
            color: #1890ff;
        }
        .stat-value.up {
            color: #f5222d;
        }
        .stat-value.down {
            color: #52c41a;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .search-box input {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            width: 240px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        .search-box input:focus {
            outline: none;
            border-color: #1890ff;
        }
        .sort-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .sort-controls select {
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            background: #fff;
            color: #333;
            font-size: 14px;
            cursor: pointer;
        }
        .sort-controls select:focus {
            outline: none;
            border-color: #1890ff;
        }
        .refresh-btn {
            padding: 8px 16px;
            background: #1890ff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .refresh-btn:hover {
            background: #40a9ff;
        }
        .table-container {
            background: #fff;
            border-radius: 4px;
            border: 1px solid #e8e8e8;
            overflow-x: auto;
            position: relative;
        }
        .table-container::-webkit-scrollbar {
            height: 12px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 6px;
        }
        .table-container::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        .scroll-hint {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.05));
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            color: #999;
            pointer-events: none;
            z-index: 10;
        }
        .scroll-hint::before {
            content: '← 左右滑动查看更多年度数据 →';
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            min-width: 1200px;
        }
        th, td {
            padding: 12px 10px;
            text-align: right;
            white-space: nowrap;
        }
        th {
            background: #fafafa;
            font-weight: 600;
            color: #666;
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
        }
        th:hover {
            background: #f0f0f0;
        }
        th:first-child, td:first-child {
            text-align: left;
            padding-left: 16px;
        }
        tr {
            border-bottom: 1px solid #f0f0f0;
        }
        tr:hover {
            background: #fafafa;
        }
        tr:last-child {
            border-bottom: none;
        }
        .strategy-name {
            color: #1890ff;
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: inline-block;
        }
        .up {
            color: #f5222d;
        }
        .down {
            color: #52c41a;
        }
        .neutral {
            color: #999;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #999;
        }
        .error {
            text-align: center;
            padding: 40px;
            color: #f5222d;
            background: #fff;
            border-radius: 4px;
        }
        .footer {
            text-align: center;
            padding: 24px 0;
            color: #999;
            font-size: 13px;
        }
        .footer a {
            color: #1890ff;
            text-decoration: none;
        }
        .year-col {
            background: #f6ffed;
        }
        .year-col:hover {
            background: #e6f7e6;
        }
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }
            .stats-bar {
                flex-wrap: wrap;
                gap: 12px;
            }
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            .search-box input {
                width: 100%;
            }
            th, td {
                padding: 10px 8px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-inner">
            <div class="logo">
                牛策网
                <span>A股因子库</span>
            </div>
            <div class="nav">
                <a href="index.html" class="active">因子列表</a>
                <a href="chart.html">风险收益图</a>
            </div>
            <div class="update-time" id="update-time">数据加载中...</div>
        </div>
    </div>
    
    <div class="container">
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="total-count">-</div>
                <div class="stat-label">策略总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-value up" id="avg-ytd">-</div>
                <div class="stat-label">平均年初收益</div>
            </div>
            <div class="stat-item">
                <div class="stat-value up" id="best-annual">-</div>
                <div class="stat-label">最佳年化收益</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="avg-sharpe">-</div>
                <div class="stat-label">平均夏普比率</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="搜索因子名称...">
            </div>
            <div class="sort-controls">
                <select id="sort-select">
                    <option value="ytd">按年初收益排序</option>
                    <option value="total_return">按总收益排序</option>
                    <option value="annual_return">按年化收益排序</option>
                    <option value="sharpe_ratio">按夏普比率排序</option>
                    <option value="month_1">按月收益排序</option>
                    <option value="day_1">按日收益排序</option>
                    <option value="max_dd">按最大回撤排序</option>
                    <option value="volatility">按波动率排序</option>
                </select>
                <button class="refresh-btn" onclick="loadData()">刷新数据</button>
            </div>
        </div>
        
        <div id="table-container">
            <div class="loading">正在加载数据...</div>
        </div>
        
        <div class="footer">
            数据来源：<a href="https://guorn.com/user/strategy?uid=13496" target="_blank">果仁网</a>
        </div>
    </div>

    <script>
        let allStrategies = [];
        let yearReturnsMap = {};
        let availableYears = [];
        let currentSort = 'ytd';
        let currentOrder = 'desc';
        
        const DATA_URL = 'https://gupiao-1254084492.cos.ap-guangzhou.myqcloud.com/strategies_data.json';
        const YEAR_RETURN_URL = 'https://raw.githubusercontent.com/yuanxiaobozi/niuce/main/strategy_year.json';
        
        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            const sign = num >= 0 ? '+' : '';
            return sign + num.toFixed(2) + '%';
        }
        
        function formatPercentValue(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            const percent = num * 100;
            const sign = percent >= 0 ? '+' : '';
            return sign + percent.toFixed(2) + '%';
        }
        
        function formatPercentAbs(value) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return '-' + Math.abs(num).toFixed(2) + '%';
        }
        
        function formatNumber(value, decimals) {
            if (value === null || value === undefined) return '-';
            const num = parseFloat(value);
            if (isNaN(num)) return '-';
            return num.toFixed(decimals);
        }
        
        function getValueClass(value) {
            if (value === null || value === undefined) return 'neutral';
            const num = parseFloat(value);
            if (isNaN(num) || num === 0) return 'neutral';
            return num > 0 ? 'up' : 'down';
        }
        
        function getPercentClass(value) {
            if (value === null || value === undefined) return 'neutral';
            const num = parseFloat(value);
            if (isNaN(num) || num === 0) return 'neutral';
            return num > 0 ? 'up' : 'down';
        }
        
        function calculateStats(data) {
            const total = data.length;
            const avgYtd = data.reduce((sum, s) => sum + (s.ytd || 0), 0) / total;
            const bestAnnual = Math.max(...data.map(s => s.annual_return || 0));
            const avgSharpe = data.reduce((sum, s) => sum + (s.sharpe_ratio || 0), 0) / total;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('avg-ytd').textContent = formatPercent(avgYtd);
            document.getElementById('best-annual').textContent = formatPercent(bestAnnual);
            document.getElementById('avg-sharpe').textContent = formatNumber(avgSharpe, 2);
        }
        
        function getYearReturns(strategyId) {
            return yearReturnsMap[strategyId] || null;
        }
        
        function renderTable(data) {
            calculateStats(data);
            
            let yearHeaders = '';
            availableYears.forEach(year => {
                yearHeaders += `<th class="year-col" onclick="sortBy('year_${year}')">${year}年收益</th>`;
            });
            
            let html = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th onclick="sortBy('name')">因子名称</th>
                                <th onclick="sortBy('day_1')">日收益</th>
                                <th onclick="sortBy('day_7')">周收益</th>
                                <th onclick="sortBy('month_1')">月收益</th>
                                <th onclick="sortBy('month_3')">季收益</th>
                                <th onclick="sortBy('ytd')">年初收益</th>
                                <th onclick="sortBy('total_return')">总收益</th>
                                <th onclick="sortBy('annual_return')">年化收益</th>
                                <th onclick="sortBy('sharpe_ratio')">夏普比率</th>
                                <th onclick="sortBy('max_dd')">最大回撤</th>
                                <th onclick="sortBy('volatility')">波动率</th>
                                <th onclick="sortBy('start_date')">开始时间</th>
                                ${yearHeaders}
                                <th onclick="sortBy('update_time')">更新时间</th>
                                <th onclick="sortBy('next_trade_date')">下次交易</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach((s) => {
                const yearData = getYearReturns(s.id);
                let yearCells = '';
                availableYears.forEach(year => {
                    let yearReturn = null;
                    if (yearData && yearData.yearly_data) {
                        const found = yearData.yearly_data.find(y => y.year === year);
                        if (found) {
                            yearReturn = found.return_rate;
                        }
                    }
                    const cellClass = getPercentClass(yearReturn);
                    yearCells += `<td class="year-col ${cellClass}">${formatPercentValue(yearReturn)}</td>`;
                });
                
                html += `
                    <tr>
                        <td><span class="strategy-name" title="${s.name}">${s.name}</span></td>
                        <td class="${getValueClass(s.day_1)}">${formatPercent(s.day_1)}</td>
                        <td class="${getValueClass(s.day_7)}">${formatPercent(s.day_7)}</td>
                        <td class="${getValueClass(s.month_1)}">${formatPercent(s.month_1)}</td>
                        <td class="${getValueClass(s.month_3)}">${formatPercent(s.month_3)}</td>
                        <td class="${getValueClass(s.ytd)}">${formatPercent(s.ytd)}</td>
                        <td class="${getValueClass(s.total_return)}">${formatPercent(s.total_return)}</td>
                        <td class="${getValueClass(s.annual_return)}">${formatPercent(s.annual_return)}</td>
                        <td class="${getValueClass(s.sharpe_ratio)}">${formatNumber(s.sharpe_ratio, 2)}</td>
                        <td class="down">${formatPercentAbs(s.max_dd)}</td>
                        <td class="${getValueClass(s.volatility)}">${formatPercent(s.volatility)}</td>
                        <td class="neutral">${s.start_date || '-'}</td>
                        ${yearCells}
                        <td class="neutral">${s.update_time || '-'}</td>
                        <td class="neutral">${s.next_trade_date || '-'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table><div class="scroll-hint"></div></div>';
            document.getElementById('table-container').innerHTML = html;
        }
        
        function sortBy(field) {
            if (currentSort === field) {
                currentOrder = currentOrder === 'desc' ? 'asc' : 'desc';
            } else {
                currentSort = field;
                currentOrder = 'desc';
            }
            document.getElementById('sort-select').value = field;
            applyFilters();
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = allStrategies.filter(s => 
                s.name.toLowerCase().includes(searchTerm)
            );
            
            filtered.sort((a, b) => {
                let aVal, bVal;
                
                if (currentSort.startsWith('year_')) {
                    const year = parseInt(currentSort.replace('year_', ''));
                    const aYearData = getYearReturns(a.id);
                    const bYearData = getYearReturns(b.id);
                    aVal = 0;
                    bVal = 0;
                    if (aYearData && aYearData.yearly_data) {
                        const found = aYearData.yearly_data.find(y => y.year === year);
                        if (found) aVal = found.return_rate || 0;
                    }
                    if (bYearData && bYearData.yearly_data) {
                        const found = bYearData.yearly_data.find(y => y.year === year);
                        if (found) bVal = found.return_rate || 0;
                    }
                } else if (currentSort === 'name' || currentSort === 'start_date' || currentSort === 'update_time' || currentSort === 'next_trade_date') {
                    const aStr = a[currentSort] || '';
                    const bStr = b[currentSort] || '';
                    return currentOrder === 'desc' ? bStr.localeCompare(aStr) : aStr.localeCompare(bStr);
                } else {
                    aVal = a[currentSort] || 0;
                    bVal = b[currentSort] || 0;
                }
                
                if (currentSort === 'max_dd' || currentSort === 'volatility') {
                    return currentOrder === 'desc' ? aVal - bVal : bVal - aVal;
                }
                
                return currentOrder === 'desc' ? bVal - aVal : aVal - bVal;
            });
            
            renderTable(filtered);
        }
        
        async function loadYearReturns() {
            try {
                const response = await fetch(YEAR_RETURN_URL + '?t=' + Date.now());
                if (!response.ok) {
                    console.warn('加载年度收益数据失败:', response.status);
                    return;
                }
                const data = await response.json();
                
                if (data.strategies && Array.isArray(data.strategies)) {
                    data.strategies.forEach(s => {
                        if (s.id) {
                            yearReturnsMap[s.id] = s;
                        }
                    });
                    
                    const allYears = new Set();
                    data.strategies.forEach(s => {
                        if (s.yearly_data && Array.isArray(s.yearly_data)) {
                            s.yearly_data.forEach(y => {
                                if (y.year && y.year <= 2025) {
                                    allYears.add(y.year);
                                }
                            });
                        }
                    });
                    
                    availableYears = Array.from(allYears).sort((a, b) => b - a);
                    console.log('加载年度收益数据成功，共', Object.keys(yearReturnsMap).length, '个策略');
                    console.log('可用年份:', availableYears);
                }
            } catch (error) {
                console.warn('加载年度收益数据失败:', error);
            }
        }
        
        async function loadData() {
            const container = document.getElementById('table-container');
            container.innerHTML = '<div class="loading">正在加载数据...</div>';
            
            try {
                const [strategiesRes] = await Promise.all([
                    fetch(DATA_URL + '?t=' + Date.now()),
                    loadYearReturns()
                ]);
                
                if (!strategiesRes.ok) {
                    throw new Error('HTTP ' + strategiesRes.status);
                }
                const data = await strategiesRes.json();
                
                if (data.strategies) {
                    allStrategies = data.strategies;
                    if (data.fetch_time) {
                        document.getElementById('update-time').textContent = '最后更新: ' + data.fetch_time;
                    }
                } else {
                    allStrategies = data;
                }
                
                applyFilters();
                
            } catch (error) {
                console.error('加载失败:', error);
                container.innerHTML = '<div class="error">数据加载失败: ' + error.message + '</div>';
            }
        }
        
        document.getElementById('search-input').addEventListener('input', applyFilters);
        
        document.getElementById('sort-select').addEventListener('change', function() {
            currentSort = this.value;
            currentOrder = 'desc';
            applyFilters();
        });
        
        loadData();
    </script>
</body>
</html>
